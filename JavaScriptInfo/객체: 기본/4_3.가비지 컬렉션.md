# 가비지 컬렉션
- 자바스크립트에서 사용하는 모든 데이터는(primitive type, object..) 메모리를 차지한다. 더이상 사용되지 않을 데이터는 어떻게 메모리에서 해제할까? 계속 메모리에 놔두면 메모리 부족해서 할수있는게 없을 것이다.
    - c에선 `free`로 메모리를 해제해준다.
- 자바스크립트는 **가비지 컬렉터**라는 녀석이 자바스크립트 엔진 내에서 끊임없이 동작한다. 이를 **가비지 컬렉션**이라 한다. **가비지 컬렉터**가 더이상 사용되지 않는 데이터에 대한 메모리를 해제해준다.
    - 개발자는 신경쓰지 않아도 자바스크립트 엔진의 가비지컬렉터가 알아서 사용하지 않는 데이터에 대한 메모리를 해제해준다. 매우 awesome하다!(사실 자바도 그렇다.. 요즘 대부분의 언어는 가비지컬렉터가 사용되지않는 데이터에대한 메모리를 해제해주는 것으로 안다.)

## 가비지 컬렉션의 기준
- **reachability(도달 가능성)**이라는 개념을 이용해서 가비지 컬렉터가 동작한다.
    - 코어자바스크립트 책에선 reference count가 0이면 가비지컬렉터가 메모리를 해제한다고 한다.
- 도달가능성이 있는 데이터는 가비지 컬렉터가 메모리를 해제하지 않는다.
    - 그럼 이 도달가능성은 어떻게 판단하는 것일까?

- 태생부터 도달가능하기에 절대 가비지컬렉터에 의해 메모리 해제되지 않는 녀석들을 먼저 알아보자
    1. 현재 함수의 지역변수와 매개변수(현재 실행컨텍스트의 .)
    2. 중첩함수의 체인에 있는 함수에서 사용되는 변수와 매개변수(클로저 개념)
    3. 전역변수 (전역컨텍스트에서 선언된 변수들)
    4. 기타..
    - 이런 녀석들을 **루트**라고 한다.
- 위에서 말한 루트나, 루트가 직접 참조하거나, 루트가 스코프체인으로 접근할수 있는 값은 모두 **도달 가능성(reachability)**이 있는 값들이다.
    - 이 녀석들은 가비지 컬렉터에 의해 메모리가 해제되지 않는다. 그말은 이 녀석들이 아니면 가비지 컬렉터에의해 메모리 해제된다는 것이겠다!

> 자바스크립트 엔진(V8..)내에선 가비지 컬렉터가 끊임~~~없이 동작하고있다. 계속 동작하며 reachability가 아닌 값들의 메모리를 해제해준다.

## 도달가능하지 못한 값 가비지컬렉터 동작

```javascript
const user = {
    name: 'John';
}

user = null;
```
- user변수에 null을 할당함과 동시에 처음에 user에 할당했던 객체는 도달할수 없게된다.(루트: user이고 user가 참조할수없다..) 그래서 객체는 계속 동작하는 가비지 컬렉터에의해 메모리 해제된다.

## 외부에서 참조하더라도 가비지컬렉터에 의해 메모리 해제될수있다.
- 이게 무슨말일까? 참조가 되면 reachability하잖아... 근데 왜 가비지컬렉터의 대상이되는거지? reachability의 정의는 '**루트**가 참조할수 있다'이므로, 루트가 아닌 변수에 의해 참조되더라도 가비지컬렉션될수있다.

```javascript
function marry(man, woman) {
  woman.husband = man;
  man.wife = woman;

  return {
    father: man,
    mother: woman
  }
}

let family = marry({
  name: "John"
}, {
  name: "Ann"
});

family = 1
```
- family가 최초에 가르키던 오브젝트의 두 프로퍼티는 서로 참조가 된다. 그런데 family에 1을 할당하면 family가 가르키던 오브젝트는 도달가능하지 못하다. 두 프로퍼티는 서로 참조는 계속 있떠라도, **루트가 접근할 수 없기 때문이다.**

## 가비지 컬렉션 내부 알고리즘
- **mark-and-sweep**이라고 불리는 내부 알고리즘으로 가비지 컬렉션은 동작한다.
    - 루트를 시작으로 루트를 mark(체크)하고 루트가 접근할수있는 데이터에 접근한뒤, mark한다. 다시 해당 데이터에서 접근할수있는 데이터에 접근한뒤 mark한다.... 이러다보면 결국 도달할수 없는 데이터들이 있는데 이건 mark되어있지 않다. mark되어있지 않는 값들은 **도달가능하지 못하고** 가비지컬렉터의 메모리 해제 대상이된다.

- 추가로 자바스크립트는 가비지컬렉션 동작을 최적화하는 여러 기법이 존재한다.
    - generation collection, incremental collection, idle-time collection(idle time이란, 동작하지않는 시간)

# 결론
- 자바스크립트 엔진 내부에 끊임없이 동작하는 가비지 컬렉터에 의해 사용되지 않는 값들은 메모리 해제를 **알아서**해준다. 이것은 개발자로 하여금 매우 편하게 도와준다.. 
- 가비지 컬렉터의 대상이 되는 것의 판단 기준은 **도달 가능성**이고 도달가능하지 못한 값들은 가비지 컬렉터에 의해 메모리 해제가 된다.
- **도달 가능성**과 참조가 있다는 것은 다르다. 도달가능성이란 루트가 언젠간 참조할수 있느냐로 판단한다.